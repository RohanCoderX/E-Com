<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Store</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --card-bg: white;
            --text-color: #333;
            --text-secondary: #666;
            --header-bg: #232f3e;
            --shadow: rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --text-secondary: #cccccc;
            --header-bg: #0f1419;
            --shadow: rgba(255,255,255,0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; }
        .header { background: var(--header-bg); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header-right { display: flex; align-items: center; gap: 1rem; }
        .theme-toggle { background: #ff9900; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .login-btn { background: #007bff; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .products-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem; }
        @media (max-width: 1200px) { .products-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 900px) { .products-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .products-grid { grid-template-columns: 1fr; } }
        .product-card { background: var(--card-bg); border-radius: 8px; padding: 1rem; box-shadow: 0 2px 4px var(--shadow); }
        .product-image { width: 100%; height: 200px; background: #ddd; border-radius: 4px; margin-bottom: 1rem; background-size: cover; background-position: center; }
        .product-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .product-price { font-size: 1.5rem; color: #b12704; font-weight: bold; margin-bottom: 0.5rem; }
        .product-description { color: var(--text-secondary); margin-bottom: 1rem; }
        .quantity-controls { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .quantity-btn { background: #ddd; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .quantity-btn:hover { background: #ccc; }
        .quantity-input { width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 0.25rem; }
        .add-to-cart { background: #ff9900; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; width: 100%; }
        .add-to-cart:hover { background: #e88900; }
        .add-to-cart:disabled { background: #ccc; cursor: not-allowed; }
        .cart { position: fixed; top: 80px; right: 20px; background: var(--card-bg); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px var(--shadow); min-width: 350px; max-height: 70vh; overflow-y: auto; }
        .cart h3 { margin-bottom: 1rem; color: var(--text-color); border-bottom: 2px solid #ff9900; padding-bottom: 0.5rem; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-color); border-radius: 8px; }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-weight: bold; color: var(--text-color); }
        .cart-item-details { font-size: 0.9rem; color: var(--text-secondary); }
        .cart-item-controls { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
        .cart-qty-btn { background: #ff9900; color: white; border: none; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-size: 0.8rem; }
        .cart-qty-btn:hover { background: #e88900; }
        .cart-qty-display { min-width: 30px; text-align: center; font-weight: bold; }
        .remove-btn { background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .remove-btn:hover { background: #c82333; }
        .cart-total { background: var(--bg-color); padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center; font-size: 1.2rem; }
        .checkout-section { border-top: 2px solid #ff9900; padding-top: 1rem; }
        .checkout-btn { background: linear-gradient(45deg, #28a745, #20c997); color: white; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; width: 100%; font-size: 1.1rem; font-weight: bold; transition: all 0.3s ease; }
        .checkout-btn:hover { background: linear-gradient(45deg, #218838, #1ea085); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }
        .checkout-btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; box-shadow: none; }
        .cart-empty { text-align: center; color: var(--text-secondary); padding: 2rem; }
        .cart-badge { background: #ff9900; color: white; border-radius: 50%; padding: 0.25rem 0.5rem; font-size: 0.8rem; position: absolute; top: -8px; right: -8px; min-width: 20px; text-align: center; }
        .loading { text-align: center; padding: 2rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); padding: 2rem; border-radius: 8px; width: 400px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; }
        .form-group input { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: var(--card-bg); color: var(--text-color); }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; margin-right: 0.5rem; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .user-info { color: white; }
        .history-btn { background: #17a2b8; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; }
        .history-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .history-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); padding: 2rem; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto; }
        .order-item { background: var(--bg-color); padding: 1rem; margin-bottom: 1rem; border-radius: 4px; border: 1px solid var(--shadow); }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-weight: bold; }
        .order-details { color: var(--text-secondary); font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>üõí E-Commerce Store</h1>
        </div>
        <div class="header-right">
            <span class="user-info" id="userInfo">Guest</span>
            <button class="history-btn" id="historyBtn" onclick="showHistory()" style="display: none;">My Orders</button>
            <button class="login-btn" id="loginBtn" onclick="showLogin()">Login</button>
            <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="loading">Loading products...</div>
        <div id="products" class="products-grid" style="display: none;"></div>
    </div>

    <div class="cart" id="cart">
        <h3>üõí Shopping Cart <span id="cart-badge" class="cart-badge" style="display: none;">0</span></h3>
        <div id="cart-items">
            <div class="cart-empty">
                <p>üõí Your cart is empty</p>
                <p>Add some products to get started!</p>
            </div>
        </div>
        <div id="cart-total" class="cart-total"><strong>Total: ‚Çπ0.00</strong></div>
        <div class="checkout-section">
            <button class="checkout-btn" id="checkout-btn" onclick="checkout()" disabled>
                üí≥ Proceed to Checkout
            </button>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h2>Login / Register</h2>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="userName" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="userEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="login()">Login</button>
                <button class="btn btn-secondary" onclick="closeLogin()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Purchase History Modal -->
    <div class="modal history-modal" id="historyModal">
        <div class="modal-content history-content">
            <h2>My Purchase History</h2>
            <div id="orderHistory">Loading...</div>
            <div class="form-group">
                <button class="btn btn-secondary" onclick="closeHistory()">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://x59iggnoyg.execute-api.us-west-2.amazonaws.com/prod';
        let products = [];
        let cart = [];
        let currentUser = null;

        // Initialize theme and user on page load
        function initializeApp() {
            loadTheme();
            loadUser();
            loadProducts();
        }

        // Theme Management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // User Management
        function loadUser() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserDisplay();
            }
        }

        function updateUserDisplay() {
            const userInfo = document.getElementById('userInfo');
            const loginBtn = document.getElementById('loginBtn');
            const historyBtn = document.getElementById('historyBtn');
            
            if (currentUser) {
                userInfo.textContent = `Hello, ${currentUser.name}`;
                loginBtn.textContent = 'Logout';
                loginBtn.onclick = logout;
                historyBtn.style.display = 'inline-block';
            } else {
                userInfo.textContent = 'Guest';
                loginBtn.textContent = 'Login';
                loginBtn.onclick = showLogin;
                historyBtn.style.display = 'none';
            }
        }

        function showLogin() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLogin() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function login() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            
            if (!name || !email) {
                alert('Please enter both name and email');
                return;
            }
            
            currentUser = { name, email, loginTime: new Date().toISOString() };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            updateUserDisplay();
            closeLogin();
            
            // Clear form
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateUserDisplay();
        }

        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/products`);
                products = await response.json();
                displayProducts();
            } catch (error) {
                document.getElementById('loading').innerHTML = 'Error loading products. Please try again later.';
            }
        }

        function displayProducts() {
            const container = document.getElementById('products');
            const loading = document.getElementById('loading');
            
            container.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-image" style="background-image: url('${product.image}'); background-size: cover; background-position: center;"></div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">‚Çπ${product.price}</div>
                    <div class="product-description">${product.description}</div>
                    <div style="color: #666; margin-bottom: 1rem;">Stock: ${product.stock}</div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity('${product.productId}', -1)">-</button>
                        <input type="number" class="quantity-input" id="qty-${product.productId}" value="1" min="1" max="${product.stock}">
                        <button class="quantity-btn" onclick="changeQuantity('${product.productId}', 1)">+</button>
                    </div>
                    <button class="add-to-cart" onclick="addToCart('${product.productId}')" ${product.stock === 0 ? 'disabled' : ''}>
                        ${product.stock === 0 ? 'Out of Stock' : 'Add to Cart'}
                    </button>
                </div>
            `).join('');
            
            loading.style.display = 'none';
            container.style.display = 'grid';
        }

        function changeQuantity(productId, change) {
            const input = document.getElementById(`qty-${productId}`);
            const product = products.find(p => p.productId === productId);
            let newValue = parseInt(input.value) + change;
            
            if (newValue < 1) newValue = 1;
            if (newValue > product.stock) newValue = product.stock;
            
            input.value = newValue;
        }

        function addToCart(productId) {
            const product = products.find(p => p.productId === productId);
            const quantityInput = document.getElementById(`qty-${product.productId}`);
            const quantity = parseInt(quantityInput.value);
            
            if (product.stock === 0) {
                alert('This product is out of stock!');
                return;
            }
            
            if (quantity > product.stock) {
                alert(`Only ${product.stock} items available in stock!`);
                return;
            }
            
            const existingItem = cart.find(item => item.productId === productId);
            
            if (existingItem) {
                const totalQuantity = existingItem.quantity + quantity;
                if (totalQuantity > product.stock) {
                    alert(`Cannot add ${quantity} more. Only ${product.stock - existingItem.quantity} items available!`);
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                cart.push({ ...product, quantity });
            }
            
            // Reset quantity input to 1
            quantityInput.value = 1;
            
            updateCartDisplay();
            alert(`Added ${quantity} ${product.name}(s) to cart!`);
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');
            const cartBadge = document.getElementById('cart-badge');
            const checkoutBtn = document.getElementById('checkout-btn');
            
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Update cart badge
            if (totalItems > 0) {
                cartBadge.textContent = totalItems;
                cartBadge.style.display = 'block';
            } else {
                cartBadge.style.display = 'none';
            }
            
            // Update cart items
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="cart-empty">
                        <p>üõí Your cart is empty</p>
                        <p>Add some products to get started!</p>
                    </div>
                `;
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = 'üí≥ Cart is Empty';
            } else {
                cartItems.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-details">‚Çπ${item.price} each</div>
                            <div class="cart-item-controls">
                                <button class="cart-qty-btn" onclick="updateCartQuantity('${item.productId}', -1)">-</button>
                                <span class="cart-qty-display">${item.quantity}</span>
                                <button class="cart-qty-btn" onclick="updateCartQuantity('${item.productId}', 1)">+</button>
                                <button class="remove-btn" onclick="removeFromCart('${item.productId}')">Remove</button>
                            </div>
                        </div>
                        <div style="font-weight: bold; color: #28a745;">‚Çπ${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `).join('');
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = `üí≥ Checkout (${totalItems} items)`;
            }
            
            cartTotal.innerHTML = `<strong>Total: ‚Çπ${total.toFixed(2)}</strong>`;
            
            // Update product display with current stock
            updateProductStock();
        }
        
        function updateCartQuantity(productId, change) {
            const item = cart.find(item => item.productId === productId);
            const product = products.find(p => p.productId === productId);
            
            if (item) {
                const newQuantity = item.quantity + change;
                
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else if (newQuantity <= product.stock) {
                    item.quantity = newQuantity;
                    updateCartDisplay();
                } else {
                    alert(`Only ${product.stock} items available in stock!`);
                }
            }
        }
        
        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            updateCartDisplay();
        }

        async function checkout() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            
            const checkoutBtn = document.getElementById('checkout-btn');
            const originalText = checkoutBtn.textContent;
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = 'üîÑ Processing Order...';

            let customerName, email;
            
            if (currentUser) {
                customerName = currentUser.name;
                email = currentUser.email;
            } else {
                customerName = prompt('Enter your name:') || 'Guest User';
                email = prompt('Enter your email:') || '';
            }
            
            const order = {
                customerName,
                email,
                items: cart.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
            };

            try {
                const response = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(order)
                });
                
                const result = await response.json();
                
                // Success animation
                checkoutBtn.textContent = '‚úÖ Order Placed Successfully!';
                checkoutBtn.style.background = '#28a745';
                
                setTimeout(() => {
                    alert(`üéâ Order placed successfully!\n\nOrder ID: ${result.orderId}\n\nThank you for your purchase!`);
                    cart = [];
                    updateCartDisplay();
                    
                    // Reset button
                    checkoutBtn.disabled = false;
                    checkoutBtn.textContent = originalText;
                    checkoutBtn.style.background = '';
                    
                    // Reload products to show updated stock
                    loadProducts();
                }, 1000);
            } catch (error) {
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = originalText;
                checkoutBtn.style.background = '';
                alert('‚ö†Ô∏è Error placing order. Please try again.');
            }
        }

        function updateProductStock() {
            // This function will be called after cart updates
            // Stock is updated server-side when order is placed
        }

        // Purchase History Functions
        async function showHistory() {
            if (!currentUser) {
                alert('Please login to view your order history');
                return;
            }
            
            document.getElementById('historyModal').style.display = 'block';
            
            try {
                const response = await fetch(`${API_URL}/orders?email=${encodeURIComponent(currentUser.email)}`);
                const orders = await response.json();
                
                const historyContainer = document.getElementById('orderHistory');
                
                if (orders.length === 0) {
                    historyContainer.innerHTML = '<p>No orders found.</p>';
                } else {
                    historyContainer.innerHTML = orders.map(order => {
                        const orderDate = new Date(order.timestamp);
                        const statusColor = getStatusColor(order.status);
                        
                        return `
                        <div class="order-item">
                            <div class="order-header">
                                <span>Order #${order.orderId}</span>
                                <span>‚Çπ${order.total.toFixed(2)}</span>
                            </div>
                            <div class="order-details">
                                <p><strong>Purchase Date:</strong> ${orderDate.toLocaleDateString()}</p>
                                <p><strong>Purchase Time:</strong> ${orderDate.toLocaleTimeString()}</p>
                                <p><strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${order.status || 'Pending'}</span></p>
                                <p><strong>Items:</strong></p>
                                <ul>
                                    ${order.items.map(item => `<li>${item.name} x${item.quantity} - ‚Çπ${(item.price * item.quantity).toFixed(2)}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `}).join('');
                }
            } catch (error) {
                document.getElementById('orderHistory').innerHTML = '<p>Error loading order history. Please try again.</p>';
            }
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'Pending': return '#ff9900';
                case 'Email Verified': return '#007bff';
                case 'Processing': return '#17a2b8';
                case 'Shipped': return '#28a745';
                case 'Delivered': return '#28a745';
                case 'Cancelled': return '#dc3545';
                default: return '#6c757d';
            }
        }
        
        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // Initialize app on page load
        initializeApp();
    </script>
</body>
</html>